# TASK-17: VERIFY Phase 2 - Test All Payment Flows End-to-End

## Status
- **Phase**: Phase 2 - speakasap-portal refactoring (Verification)
- **Priority**: Critical (must pass before deployment)
- **Dependencies**: TASK-08 through TASK-16 (all Phase 2 tasks)
- **Estimated Time**: 2-3 hours

## Objective
Verify that all Phase 2 tasks are completed correctly and all payment flows work end-to-end with payments-microservice. This is an orchestration/verification task.

## Prerequisites
- All Phase 2 tasks completed (TASK-08 through TASK-16)
- payments-microservice is running and accessible
- speakasap-portal is running
- Database migrations applied
- Environment variables configured

## Verification Steps

### 1. Code Compilation Check
- [ ] Run Django checks: `python manage.py check`
- [ ] Verify no syntax errors
- [ ] Check for any import errors
- [ ] Verify all migrations are applied
- [ ] Check for any linting errors

### 2. ExternalPayment Model Verification
- [ ] Verify ExternalPayment model exists and extends Payment
- [ ] Check all fields are defined correctly
- [ ] Verify migration is applied: `orders_externalpayment` table exists
- [ ] Test model instantiation
- [ ] Verify model works with Payment model methods

### 3. PaymentFactory Verification
- [ ] Verify PaymentFactory calls PaymentServiceClient
- [ ] Check all payment methods (paypal, webpay, inner, invoice) use microservice
- [ ] Verify ExternalPayment instances are created correctly
- [ ] Test payment creation for each method
- [ ] Verify error handling works

### 4. WebPay Flow Verification
- [ ] Test WebPay payment creation
- [ ] Verify billing details are passed via metadata
- [ ] Check redirect to WebPay gateway works
- [ ] Test webhook handling (if ProcessView updated)
- [ ] Verify payment completion flow

### 5. Inner Payment Flow Verification
- [ ] Test Inner payment creation
- [ ] Verify userId is included in metadata
- [ ] Test insufficient balance error handling
- [ ] Verify payment completion via webhook
- [ ] Check balance deduction happens in microservice

### 6. Invoice Payment Flow Verification
- [ ] Test Invoice payment creation
- [ ] Verify invoice number is generated by microservice
- [ ] Check invoice number is displayed to user
- [ ] Test payment confirmation flow
- [ ] Verify invoice record creation in microservice

### 7. PayPal Flow Verification
- [ ] Test PayPal payment creation
- [ ] Verify redirect to PayPal works
- [ ] Test payment return handler
- [ ] Check payment status checking via microservice
- [ ] Verify payment completion flow

### 8. Webhook Endpoint Verification
- [ ] Verify webhook endpoint exists at `/api/payments/webhook`
- [ ] Test webhook endpoint with sample payload
- [ ] Verify API key authentication works
- [ ] Check ExternalPayment lookup works
- [ ] Test payment completion via webhook
- [ ] Verify idempotency (duplicate webhooks)
- [ ] Check error handling

### 9. Environment Configuration Verification
- [ ] Verify `PAYMENT_SERVICE_URL` is configured
- [ ] Check `PAYMENT_API_KEY` is configured
- [ ] Verify settings are accessible
- [ ] Test environment variable override

### 10. Deprecated Code Verification
- [ ] Verify deprecated code is commented out
- [ ] Check comments reference microservice location
- [ ] Verify code is kept for reference
- [ ] Confirm no broken references

### 11. Integration Testing
- [ ] Test complete payment flow for each method:
  - Payment creation → Microservice → Gateway → Webhook → Completion
- [ ] Verify payment status updates correctly
- [ ] Check order completion works
- [ ] Test error scenarios
- [ ] Verify retry logic works

### 12. API Compatibility Check
- [ ] Verify `MyOrderMethodView.post()` in `orders/api_views.py` still works
- [ ] Check payment serializers work with ExternalPayment model
- [ ] Test API endpoints with new payment flow
- [ ] Verify API responses include correct payment data
- [ ] Test payment creation via API endpoints
- [ ] Verify backward compatibility (no breaking changes)
- [ ] Confirm PaymentFactory changes don't break API endpoints

### 13. Logging Verification
- [ ] Verify extensive logging is implemented across all payment flows
- [ ] Check logging is configured for centralized logging-microservice
- [ ] Verify logs are being sent to logging-microservice (check logs)
- [ ] Test log levels are appropriate (error, warn, info, debug)
- [ ] Verify sensitive data is NOT logged (API keys, passwords, full payment details)
- [ ] Check logs include proper context (paymentId, orderId, userId, etc.)
- [ ] Verify error logging includes stack traces and full context
- [ ] Check webhook processing is logged
- [ ] Verify payment creation operations are logged
- [ ] Confirm database operations are logged (without sensitive data)

## Files to Review

1. `speakasap-portal/orders/external_payment/models.py`
2. `speakasap-portal/orders/utils.py` (PaymentFactory)
3. `speakasap-portal/orders/webpay/views.py`
4. `speakasap-portal/orders/webpay/forms.py`
5. `speakasap-portal/orders/views.py` (InnerPaymentView)
6. `speakasap-portal/orders/invoice/views.py`
7. `speakasap-portal/orders/paypal/views.py`
8. `speakasap-portal/orders/webhooks/views.py`
9. `speakasap-portal/orders/api_views.py` (API endpoints compatibility)
10. `speakasap-portal/portal/local_settings.py`
11. `speakasap-portal/orders/urls.py`

## Acceptance Criteria

- [ ] All code compiles without errors
- [ ] ExternalPayment model works correctly
- [ ] PaymentFactory uses microservice for all methods
- [ ] All payment flows work end-to-end
- [ ] Webhook endpoint works correctly
- [ ] Environment configuration is correct
- [ ] Deprecated code is properly commented
- [ ] No broken functionality
- [ ] All payment methods work correctly
- [ ] Error handling works
- [ ] Extensive logging is implemented and verified across all payment flows
- [ ] Logging service is properly configured and logs are being sent

## Verification Checklist

### Code Quality
- [ ] No syntax errors
- [ ] No import errors
- [ ] Proper error handling
- [ ] Logging is implemented
- [ ] Code follows Django best practices

### Functionality
- [ ] WebPay payment flow works
- [ ] Inner payment flow works
- [ ] Invoice payment flow works
- [ ] PayPal payment flow works
- [ ] Webhook handling works
- [ ] Payment completion works
- [ ] Error handling works

### Integration
- [ ] payments-microservice connection works
- [ ] Payment creation works
- [ ] Payment status updates work
- [ ] Webhook callbacks work
- [ ] Order completion works

### Configuration
- [ ] Environment variables are set
- [ ] Settings are configured correctly
- [ ] API keys are configured
- [ ] Database migrations are applied

## Notes

- This is a verification task - do not implement new features
- Focus on verifying that all previous tasks are completed correctly
- If issues are found, create new tasks to fix them
- Document any issues or missing functionality
- This task must pass before deployment to production

## Related Tasks
- TASK-08 through TASK-16 (all Phase 2 tasks)
- TASK-07: VERIFY Phase 1 (prerequisite)

## Next Steps

If verification passes:
- Deploy to staging environment
- Perform integration testing
- Deploy to production

If verification fails:
- Document issues
- Create fix tasks
- Re-verify after fixes

## Testing Recommendations

- Test with real payment gateways (if test environment available)
- Test error scenarios (network failures, invalid data, etc.)
- Test concurrent payment creation
- Test webhook retry logic
- Test payment completion for all methods
- Verify database records are created correctly
- Check logs for any errors or warnings
